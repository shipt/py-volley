language: python
team: machine-learning
metadata:
  description: The bundle engine consists of workers + queues to process incoming bundle requests from Kafka and optimize
deploy:
  pipeline: harbor
  chart: default
  group: ds
  environments:
  - name: production
    releaseStrategy:
      branch: main
      tagFormat: semver
  - name: staging
    releaseStrategy:
      branch: main
  deployLocations:
  - provider: gcp
    region: us-central1
roles:
  webservers:
    - name: metrics-server
      routes:
      - subdomain: bundle-engine-metrics
      timeout: 5s
      command: uvicorn monitoring.monitoring:app
      healthcheck: /
      port: 8000
      retryPolicy:
        count: 3
        perTryTimeout: 15s
      replicaCount: 4
      resources:
        cpu: 50m
        memory: 250M
      telemetry:
        prometheus:
          enabled: true
          port: 8000
  worker:
    - name: features
      command: python main.py features
      replicaCount: 1
    - name: triage
      command: python main.py triage
      replicaCount: 1
    - name: optimizer
      command: python main.py optimizer
      replicaCount: 1
    - name: fallback
      command: python main.py fallback
      replicaCount: 1
    - name: collector
      command: python main.py collector
      replicaCount: 1
datastores:
  cloudSql:
    - name: ml-bundle-engine
      configVar: CLOUDSQL_DATABASE_URL
      size:
        storage: 10 GB
        ram: 4 GB
  memoryStore:
    - name: redis-queue
      configVar: REDIS_HOST
      size: 1
  kafka:
    topics:
      - name: bundle-engine-input
        configVar: INPUT_TOPIC
        nameAttributes:
          domain: ds-marketplace
          messageType: BUS
          version: v1
          event:
            type: BUSINESS
            eventDescription: bundle_engine_input
      - name: bundle-engine-output
        configVar: OUTPUT_TOPIC
        nameAttributes:
          domain: ds-marketplace
          messageType: BUS
          version: v1
          event:
            type: BUSINESS
            eventDescription: bundle_engine_output
